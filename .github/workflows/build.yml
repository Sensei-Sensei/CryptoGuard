name: Build CryptoGuard APK

on:
  workflow_dispatch:

jobs:
  build-android:
    name: Build for Android
    runs-on: ubuntu-latest
    steps:
      - name: Checkout do código
        uses: actions/checkout@v4

      - name: Instalar dependências
        run: |
          sudo apt update
          sudo apt install -y \
            python3-pip \
            git \
            zip \
            unzip \
            openjdk-17-jdk \
            autoconf \
            libtool \
            pkg-config \
            zlib1g-dev \
            libncurses5-dev \
            libncursesw5-dev \
            cmake \
            libffi-dev \
            libssl-dev \
            ccache \
            wget

      - name: Instalar Cython e Buildozer
        run: |
          pip3 install --user --upgrade pip
          pip3 install --user --upgrade cython==0.29.33 buildozer

      - name: Adicionar ~/.local/bin ao PATH
        run: echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Criar .buildozer com permissões
        run: |
          mkdir -p .buildozer
          chmod 755 .buildozer

      - name: Configurar SDK e aceitar licenças
        run: |
          # Criar diretório do SDK
          mkdir -p ~/.buildozer/android/platform/android-sdk
          
          # Baixar command line tools
          wget -q https://dl.google.com/android/repository/commandlinetools-linux-9477386_latest.zip
          unzip -q commandlinetools-linux-9477386_latest.zip -d ~/.buildozer/android/platform/android-sdk/
          mv ~/.buildozer/android/platform/android-sdk/cmdline-tools ~/.buildozer/android/platform/android-sdk/latest
          mkdir -p ~/.buildozer/android/platform/android-sdk/cmdline-tools
          mv ~/.buildozer/android/platform/android-sdk/latest ~/.buildozer/android/platform/android-sdk/cmdline-tools/
          
          # Adicionar ao PATH
          export PATH=$PATH:~/.buildozer/android/platform/android-sdk/cmdline-tools/latest/bin
          
          # Aceitar todas as licenças automaticamente
          yes | sdkmanager --licenses
          
          # Instalar build-tools específicas
          sdkmanager "build-tools;33.0.0" "platform-tools" "platforms;android-33"

      - name: Configurar Buildozer
        run: |
          # Configurar buildozer.spec para usar SDK correto
          cat > buildozer.spec << 'EOF'
          [app]
          title = CryptoGuard
          package.name = cryptoguard
          package.domain = com.stazin
          source.dir = .
          source.include_exts = py,png,jpg,kv,atlas,txt
          version = 1.0
          requirements = python3,kivy
          orientation = portrait
          osx.python_version = 3
          osx.kivy_version = 2.1.0
          fullscreen = 0

          [buildozer]
          log_level = 2
          warn_on_root = 1

          [android]
          api = 33
          minapi = 21
          ndk = 25b
          sdk = 33
          arch = arm64-v8a
          permissions = INTERNET
          android.accept_sdk_license = True
          EOF

      - name: Compilar APK com Buildozer
        run: |
          export PATH=$PATH:~/.buildozer/android/platform/android-sdk/cmdline-tools/latest/bin
          buildozer -v android debug 2>&1 | tee buildozer.log

      - name: Verificar se APK foi gerado
        id: check_apk
        run: |
          APK_FILE=$(ls bin/*.apk 2>/dev/null | head -n 1)
          if [ -n "$APK_FILE" ]; then
            echo "✅ APK encontrado: $APK_FILE"
            echo "filename=$APK_FILE" >> $GITHUB_OUTPUT
          else
            echo "❌ APK não encontrado!"
            echo "Últimas 100 linhas do log:"
            tail -n 100 buildozer.log
            exit 1
          fi

      - name: Upload do APK
        uses: actions/upload-artifact@v4
        with:
          name: CryptoGuard-APK
          path: ${{ steps.check_apk.outputs.filename }}
          if-no-files-found: error

      - name: Upload do log em caso de erro
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: buildozer-log
          path: buildozer.log
