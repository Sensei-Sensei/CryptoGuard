name: Build CryptoGuard APK

on:
  workflow_dispatch:

jobs:
  build-android:
    name: Build for Android
    runs-on: ubuntu-latest
    steps:
      - name: Checkout do código
        uses: actions/checkout@v4

      - name: Instalar dependências
        run: |
          sudo apt update
          sudo apt install -y \
            python3-pip \
            git \
            zip \
            unzip \
            openjdk-17-jdk \
            autoconf \
            libtool \
            pkg-config \
            zlib1g-dev \
            libncurses5-dev \
            libncursesw5-dev \
            cmake \
            libffi-dev \
            libssl-dev \
            ccache \
            wget

      - name: Instalar Cython e Buildozer
        run: |
          pip3 install --user --upgrade pip
          pip3 install --user --upgrade cython==0.29.33 buildozer

      - name: Adicionar ~/.local/bin ao PATH
        run: echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Baixar SDK Command Line Tools
        run: |
          mkdir -p $HOME/android-sdk
          cd $HOME/android-sdk
          wget -q https://dl.google.com/android/repository/commandlinetools-linux-9477386_latest.zip
          unzip -q commandlinetools-linux-9477386_latest.zip
          mkdir -p cmdline-tools/latest
          mv cmdline-tools/* cmdline-tools/latest/ 2>/dev/null || true
          rm commandlinetools-linux-9477386_latest.zip
          echo "$HOME/android-sdk/cmdline-tools/latest/bin" >> $GITHUB_PATH
          echo "$HOME/android-sdk/platform-tools" >> $GITHUB_PATH

      - name: Aceitar licenças
        run: |
          cd $HOME/android-sdk/cmdline-tools/latest/bin
          yes | ./sdkmanager --licenses || true
          ./sdkmanager "platform-tools" "platforms;android-33" "build-tools;33.0.0"

      - name: Criar link simbólico para enganar o Buildozer
        run: |
          mkdir -p $HOME/.buildozer/android/platform/android-sdk
          ln -sf $HOME/android-sdk $HOME/.buildozer/android/platform/android-sdk
          mkdir -p $HOME/.buildozer/android/platform/android-sdk/tools
          ln -sf $HOME/android-sdk/cmdline-tools/latest/bin $HOME/.buildozer/android/platform/android-sdk/tools/bin

      - name: Criar buildozer.spec
        run: |
          cat > buildozer.spec << 'EOF'
          [app]
          title = CryptoGuard
          package.name = cryptoguard
          package.domain = com.stazin
          source.dir = .
          source.include_exts = py,png,jpg,kv,atlas,txt
          version = 1.0
          requirements = python3,kivy
          orientation = portrait
          osx.python_version = 3
          osx.kivy_version = 2.1.0
          fullscreen = 0

          [buildozer]
          log_level = 2
          warn_on_root = 1

          [android]
          api = 33
          minapi = 21
          ndk = 25b
          sdk = 33
          arch = arm64-v8a
          permissions = INTERNET
          android.accept_sdk_license = True
          android.ndk_path = /home/runner/.buildozer/android/platform/android-ndk-r25b
          android.sdk_path = /home/runner/.buildozer/android/platform/android-sdk
          android.ant_path = /home/runner/.buildozer/android/platform/apache-ant-1.9.4
          EOF

      - name: Criar .buildozer bootstrap
        run: |
          mkdir -p .buildozer/android/platform
          touch .buildozer/android/platform/.ready

      - name: Compilar APK
        run: |
          export PATH=$PATH:$HOME/android-sdk/cmdline-tools/latest/bin:$HOME/android-sdk/platform-tools
          buildozer -v android debug 2>&1 | tee buildozer.log

      - name: Verificar APK
        id: check_apk
        run: |
          APK_FILE=$(ls bin/*.apk 2>/dev/null | head -n 1)
          if [ -n "$APK_FILE" ]; then
            echo "✅ APK encontrado: $APK_FILE"
            echo "filename=$APK_FILE" >> $GITHUB_OUTPUT
          else
            echo "❌ APK não encontrado!"
            echo "Últimas 100 linhas do log:"
            tail -n 100 buildozer.log
            exit 1
          fi

      - name: Upload do APK
        uses: actions/upload-artifact@v4
        with:
          name: CryptoGuard-APK
          path: ${{ steps.check_apk.outputs.filename }}
          if-no-files-found: error

      - name: Upload do log em caso de erro
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: buildozer-log
          path: buildozer.log
