name: Build CryptoGuard APK

on:
  workflow_dispatch:

jobs:
  build-android:
    name: Build for Android
    runs-on: ubuntu-latest
    steps:
      - name: Checkout do código
        uses: actions/checkout@v4

      - name: Instalar dependências
        run: |
          sudo apt update
          sudo apt install -y \
            python3-pip \
            git \
            zip \
            unzip \
            openjdk-17-jdk \
            autoconf \
            libtool \
            pkg-config \
            zlib1g-dev \
            libncurses5-dev \
            libncursesw5-dev \
            cmake \
            libffi-dev \
            libssl-dev \
            ccache \
            wget

      - name: Instalar Cython e Buildozer
        run: |
          pip3 install --user --upgrade pip
          pip3 install --user --upgrade cython==0.29.33 buildozer

      - name: Adicionar ~/.local/bin ao PATH
        run: echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Criar estrutura completa do SDK manualmente
        run: |
          # Criar diretórios
          mkdir -p $HOME/android-sdk
          cd $HOME/android-sdk
          
          # Baixar command line tools
          wget -q https://dl.google.com/android/repository/commandlinetools-linux-11076708_latest.zip
          unzip -q commandlinetools-linux-11076708_latest.zip
          
          # Criar estrutura correta
          mkdir -p cmdline-tools/latest
          mv cmdline-tools/* cmdline-tools/latest/ 2>/dev/null || true
          
          # Baixar e instalar NDK
          wget -q https://dl.google.com/android/repository/android-ndk-r25b-linux.zip
          unzip -q android-ndk-r25b-linux.zip
          mv android-ndk-r25b $HOME/android-ndk
          
          # Criar link simbólico para enganar o Buildozer
          mkdir -p $HOME/.buildozer/android/platform
          ln -sf $HOME/android-sdk $HOME/.buildozer/android/platform/android-sdk
          
          # Criar diretório tools/bin para o Buildozer encontrar
          mkdir -p $HOME/.buildozer/android/platform/android-sdk/tools/bin
          
          # Criar script fake sdkmanager
          cat > $HOME/.buildozer/android/platform/android-sdk/tools/bin/sdkmanager << 'EOF'
          #!/bin/bash
          echo "SDK Manager desabilitado - usando instalação manual"
          exit 0
          EOF
          chmod +x $HOME/.buildozer/android/platform/android-sdk/tools/bin/sdkmanager
          
          # Criar script fake avdmanager
          cat > $HOME/.buildozer/android/platform/android-sdk/tools/bin/avdmanager << 'EOF'
          #!/bin/bash
          echo "AVD Manager desabilitado"
          exit 0
          EOF
          chmod +x $HOME/.buildozer/android/platform/android-sdk/tools/bin/avdmanager
          
          # Adicionar ao PATH
          echo "$HOME/android-sdk/cmdline-tools/latest/bin" >> $GITHUB_PATH
          echo "$HOME/android-sdk/platform-tools" >> $GITHUB_PATH
          
          # Limpar arquivos temporários
          rm -f *.zip

      - name: Aceitar licenças manualmente
        run: |
          cd $HOME/android-sdk/cmdline-tools/latest/bin
          yes | ./sdkmanager --licenses || true
          ./sdkmanager "platform-tools" "platforms;android-33" "build-tools;33.0.0"

      - name: Clonar python-for-android
        run: |
          mkdir -p $HOME/.buildozer/android/platform
          cd $HOME/.buildozer/android/platform
          git clone https://github.com/kivy/python-for-android.git
          cd python-for-android
          pip3 install --user -e .

      - name: Criar buildozer.spec otimizado
        run: |
          cat > buildozer.spec << 'EOF'
          [app]
          title = CryptoGuard
          package.name = cryptoguard
          package.domain = com.stazin
          source.dir = .
          source.include_exts = py,png,jpg,kv,atlas,txt
          version = 1.0
          requirements = python3,kivy
          orientation = portrait
          osx.python_version = 3
          osx.kivy_version = 2.1.0
          fullscreen = 0

          [buildozer]
          log_level = 2
          warn_on_root = 1

          [android]
          api = 33
          minapi = 21
          ndk = 25b
          sdk = 33
          arch = arm64-v8a
          permissions = INTERNET
          android.accept_sdk_license = True
          android.ndk_path = /home/runner/android-ndk
          android.sdk_path = /home/runner/android-sdk
          android.ant_path = /home/runner/.buildozer/android/platform/apache-ant-1.9.4
          p4a.local_recipes = /home/runner/.buildozer/android/platform/python-for-android
          android.skip_ant = True
          android.gradle_dependencies = 'com.android.tools.build:gradle:7.4.2'
          
          [p4a]
          local_recipes = /home/runner/.buildozer/android/platform/python-for-android
          EOF

      - name: Criar arquivo de permissões
        run: |
          mkdir -p .buildozer/android/platform
          touch .buildozer/android/platform/android-ndk-r25b
          touch .buildozer/android/platform/android-sdk

      - name: Compilar APK
        run: |
          export PATH=$PATH:$HOME/android-sdk/cmdline-tools/latest/bin:$HOME/android-sdk/platform-tools
          export ANDROID_HOME=$HOME/android-sdk
          export ANDROID_SDK_ROOT=$HOME/android-sdk
          export ANDROID_NDK_HOME=$HOME/android-ndk
          
          # Limpar e compilar
          rm -rf .buildozer
          buildozer -v android debug 2>&1 | tee buildozer.log

      - name: Verificar APK
        id: check_apk
        run: |
          APK_FILE=$(ls bin/*.apk 2>/dev/null | head -n 1)
          if [ -n "$APK_FILE" ]; then
            echo "✅ APK encontrado: $APK_FILE"
            echo "filename=$APK_FILE" >> $GITHUB_OUTPUT
          else
            echo "❌ APK não encontrado!"
            echo "=== CONTEÚDO DA PASTA BIN ==="
            ls -la bin/ || echo "Pasta bin vazia"
            echo "=== ÚLTIMAS 100 LINHAS DO LOG ==="
            tail -n 100 buildozer.log
            exit 1
          fi

      - name: Upload do APK
        uses: actions/upload-artifact@v4
        with:
          name: CryptoGuard-APK
          path: ${{ steps.check_apk.outputs.filename }}
          if-no-files-found: error

      - name: Upload do log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: buildozer-log
          path: buildozer.log
