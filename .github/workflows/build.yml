name: Build CryptoGuard APK

on:
  workflow_dispatch:

jobs:
  build-android:
    name: Build for Android
    runs-on: ubuntu-latest
    steps:
      - name: Checkout do código
        uses: actions/checkout@v4

      - name: Instalar dependências (incluindo Android SDK via apt)
        run: |
          sudo apt update
          sudo apt install -y \
            python3-pip \
            git \
            zip \
            unzip \
            openjdk-17-jdk \
            autoconf \
            libtool \
            pkg-config \
            zlib1g-dev \
            libncurses5-dev \
            libncursesw5-dev \
            cmake \
            libffi-dev \
            libssl-dev \
            ccache \
            wget \
            android-sdk

      - name: Configurar variáveis de ambiente do Android SDK
        run: |
          echo "ANDROID_HOME=/usr/lib/android-sdk" >> $GITHUB_ENV
          echo "ANDROID_SDK_ROOT=/usr/lib/android-sdk" >> $GITHUB_ENV
          echo "PATH=$PATH:/usr/lib/android-sdk/cmdline-tools/latest/bin:/usr/lib/android-sdk/platform-tools" >> $GITHUB_ENV

      - name: Aceitar licenças (se necessário)
        run: |
          if [ -f /usr/lib/android-sdk/cmdline-tools/latest/bin/sdkmanager ]; then
            yes | /usr/lib/android-sdk/cmdline-tools/latest/bin/sdkmanager --licenses || true
          elif [ -f /usr/lib/android-sdk/tools/bin/sdkmanager ]; then
            yes | /usr/lib/android-sdk/tools/bin/sdkmanager --licenses || true
          else
            echo "⚠️ sdkmanager não encontrado, continuando..."
          fi

      - name: Instalar Cython e Buildozer
        run: |
          pip3 install --user --upgrade pip
          pip3 install --user --upgrade cython==0.29.33 buildozer

      - name: Adicionar ~/.local/bin ao PATH
        run: echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Criar buildozer.spec
        run: |
          cat > buildozer.spec << 'EOF'
          [app]
          title = CryptoGuard
          package.name = cryptoguard
          package.domain = com.stazin
          source.dir = .
          source.include_exts = py,png,jpg,kv,atlas,txt
          version = 1.0
          requirements = python3,kivy
          orientation = portrait
          osx.python_version = 3
          osx.kivy_version = 2.1.0
          fullscreen = 0

          [buildozer]
          log_level = 2
          warn_on_root = 1

          [android]
          api = 33
          minapi = 21
          ndk = 25b
          sdk = 33
          arch = arm64-v8a
          permissions = INTERNET
          android.accept_sdk_license = True
          android.ndk_path = /home/runner/.buildozer/android/platform/android-ndk-r25b
          android.sdk_path = /usr/lib/android-sdk
          android.ant_path = /home/runner/.buildozer/android/platform/apache-ant-1.9.4
          android.sdk_manager_tools_version = 9.0
          EOF

      - name: Compilar APK
        run: |
          # Garantir que o Buildozer use o SDK correto
          mkdir -p /home/runner/.buildozer/android/platform
          ln -sf /usr/lib/android-sdk /home/runner/.buildozer/android/platform/android-sdk
          
          buildozer -v android debug 2>&1 | tee buildozer.log

      - name: Verificar APK
        id: check_apk
        run: |
          APK_FILE=$(ls bin/*.apk 2>/dev/null | head -n 1)
          if [ -n "$APK_FILE" ]; then
            echo "✅ APK encontrado: $APK_FILE"
            echo "filename=$APK_FILE" >> $GITHUB_OUTPUT
          else
            echo "❌ APK não encontrado!"
            echo "Últimas 100 linhas do log:"
            tail -n 100 buildozer.log
            exit 1
          fi

      - name: Upload do APK
        uses: actions/upload-artifact@v4
        with:
          name: CryptoGuard-APK
          path: ${{ steps.check_apk.outputs.filename }}
          if-no-files-found: error

      - name: Upload do log em caso de erro
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: buildozer-log
          path: buildozer.log
